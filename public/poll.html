<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main>
        <h1></h1>
        <ul id="options"></ul>
    </main>

    <script>
        const id = window.location.pathname.replaceAll('/', '')

        const question = document.querySelector('main > h1')
        const optionsList = document.querySelector('ul')
        let optionsFromServer = []
        
        // Redirects to homepage if ID is invalid
        async function onLoad() {
            const idsRes = await fetch('/ids')
            const {ids} = await idsRes.json()

            if (!ids.includes(id)) {
                window.location.href = '/'
            }

            const response = await fetch('/data/' + id) 
            const {data} = await response.json()

            optionsFromServer = data.options
            question.innerText = data.question + (data.question.includes('?') ? '' : '?')

            let newInnerListHTML = ''
            Object.keys(data.options).forEach((option, index) => {
                newInnerListHTML += `<li id="${option}"><i class="fa-solid fa-arrow-right"></i>${option}</li>`
            })

            optionsList.innerHTML = newInnerListHTML
            const optionsLi = document.querySelectorAll('li')
            optionsLi.forEach(option => {
                option.addEventListener('click', clicked)
            })
        }
        onLoad()
        
        function clicked(index) {
            const selected = index.target.id
            const maxNumberOfVotes = Math.max(...Object.values(optionsFromServer))
            const optionsLi = document.querySelectorAll('li')
            optionsLi.forEach(val => {
                const option = val.id
                val.removeEventListener('click', clicked) 
                val.style.background = `white`

                if (maxNumberOfVotes !== 0) {
                    val.style.width = optionsFromServer[`${option}`] === 0 ? '5%' : `
                    ${(optionsFromServer[option] / maxNumberOfVotes)*100}%`
                }
            })
        }
    </script>
</body>
</html>